---
import BaseLayout from "./BaseLayout.astro";

interface DocFrontmatter {
  title: string;
  currentPath: string;
}

interface Props {
  frontmatter?: Partial<DocFrontmatter>;
  title?: string;
  currentPath?: string;
}

const props = Astro.props as Props;
const frontmatter = props.frontmatter ?? {};
const title = frontmatter.title ?? props.title ?? "";
const currentPath = frontmatter.currentPath ?? props.currentPath ?? "/";

const contentHtml = await Astro.slots.render("default");

type TocItem = {
  level: number;
  id: string;
  text: string;
};

function stripHtmlTags(value: string): string {
  return value
    .replace(/<[^>]*>/g, "")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&#39;/g, "'")
    .replace(/&quot;/g, '"')
    .trim();
}

const headingRegex = /<h([2-4])[^>]*id="([^"]+)"[^>]*>([\s\S]*?)<\/h\1>/g;
const tocItems: TocItem[] = [];
let match: RegExpExecArray | null;

while ((match = headingRegex.exec(contentHtml)) !== null) {
  const level = Number(match[1]);
  const id = match[2];
  const text = stripHtmlTags(match[3]);
  if (id && text) {
    tocItems.push({ level, id, text });
  }
}

const hasToc = tocItems.length > 0;
---

<BaseLayout currentPath={currentPath} title={title}>
  <div class={hasToc ? "md-docs-layout has-toc" : "md-docs-layout"}>
    {
      hasToc ? (
        <aside class="md-docs-toc">
          <p class="md-docs-toc-title">このページの目次</p>
          <nav aria-label="このページの目次" class="md-docs-toc-nav">
            {
              tocItems.map((item) => (
                <a class={`md-docs-toc-link level-${item.level}`} href={`#${item.id}`}>
                  {item.text}
                </a>
              ))
            }
          </nav>
        </aside>
      ) : null
    }

    <section class="md-docs-main">
      <article class="doc-content md-docs-content">
        <Fragment set:html={contentHtml} />
      </article>
    </section>
  </div>
</BaseLayout>
